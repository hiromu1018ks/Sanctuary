# Sanctuary独自リアクション機能 - 完全設計分析

## 概要
Sanctuaryの「心の安全地帯」コンセプトを体現した独自リアクション機能の完全設計分析結果。従来の「いいね」を超えた感情豊かなリアクションシステム。

## 1. 要件定義

### 独自リアクション4種類
- **感謝 (Thanks)** 🙏 
  - アイコン: Handshake (Lucide React)
  - カラー: Amber系 (text-amber-600)
  - 意味: 投稿者への感謝の気持ち
- **応援 (Support)** 💪
  - アイコン: Users (Lucide React) 
  - カラー: Emerald系 (text-emerald-600)
  - 意味: 励ましと支援の意志
- **共感 (Empathy)** ❤️
  - アイコン: Heart (Lucide React)
  - カラー: Blue系 (text-blue-600)
  - 意味: 気持ちの共有と理解
- **素敵 (Wonderful)** ⭐
  - アイコン: Star (Lucide React)
  - カラー: Purple系 (text-purple-600)
  - 意味: 美しい投稿への賞賛

### 制約条件
- Next.js 15 + TypeScript + Tailwind v4環境
- Auth.js v5認証システム統合
- PostgreSQL + Prisma データ永続化
- レスポンシブ3カラムレイアウト親和性

## 2. データベース設計

### 既存Reactionモデル活用
```prisma
model Reaction {
  id            String   @id @default(cuid())
  postId        String
  userProfileId String
  reactionType  String   @db.VarChar(20) // 'thanks', 'support', 'empathy', 'wonderful'
  createdAt     DateTime @default(now())
  
  post        Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  userProfile UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userProfileId, reactionType])
  @@index([postId])
  @@index([reactionType])
}
```

### 設計思想
- ユニーク制約でリアクション重複防止
- カスケード削除で整合性保証
- インデックス最適化でクエリ高速化

## 3. API設計

### RESTful エンドポイント
```typescript
// リアクション作成/削除（トグル方式）
POST   /api/reactions
DELETE /api/reactions

// 投稿のリアクション一覧取得
GET    /api/posts/{postId}/reactions

// ユーザーのリアクション履歴
GET    /api/users/me/reactions
```

### 型定義
```typescript
interface ReactionRequest {
  postId: string;
  reactionType: 'thanks' | 'support' | 'empathy' | 'wonderful';
}

interface ReactionResponse {
  id: string;
  postId: string;
  userProfileId: string;
  reactionType: string;
  createdAt: string;
  user: {
    nickname: string;
    profileImageUrl?: string;
  };
}

type ReactionType = 'thanks' | 'support' | 'empathy' | 'wonderful';

interface ReactionCounts {
  thanks: number;
  support: number;
  empathy: number;
  wonderful: number;
}

interface UserReactionState {
  thanks: boolean;
  support: boolean;
  empathy: boolean;
  wonderful: boolean;
}
```

## 4. React コンポーネント設計

### コンポーネント階層
```typescript
// ReactionBar（メインコンポーネント）
interface ReactionBarProps {
  postId: string;
  reactions: ReactionCounts;
  userReactions: UserReactionState;
}

// ReactionButton（個別ボタン）
interface ReactionButtonProps {
  postId: string;
  reactionType: ReactionType;
  count: number;
  isActive: boolean;
  onToggle: (postId: string, type: ReactionType) => Promise<void>;
}
```

### 設計パターン
- Compound Component: ReactionBar > ReactionButton
- Lucide React Icons活用
- Tailwind v4 スタイリング
- Accessibility対応（ARIA labels）

## 5. 状態管理戦略

### 楽観的更新パターン
```typescript
const useReactions = (postId: string) => {
  const [optimisticState, setOptimisticState] = useState<ReactionCounts>();
  const [userReactions, setUserReactions] = useState<UserReactionState>();

  const toggleReaction = async (type: ReactionType) => {
    // 1. 即座にUI更新
    updateOptimisticState(type);
    
    try {
      // 2. API呼び出し
      await api.toggleReaction(postId, type);
    } catch (error) {
      // 3. エラー時ロールバック
      rollbackOptimisticUpdate();
    }
  };
};
```

### エラーハンドリング
- ネットワークエラー: 自動リトライ（最大3回）
- 認証エラー: ログイン画面リダイレクト
- 楽観的更新失敗: 即座ロールバック
- 制限エラー: Toast通知

## 6. UI/UX設計

### 視覚デザイン
```css
.reaction-thanks { @apply text-amber-600 hover:bg-amber-50; }
.reaction-support { @apply text-emerald-600 hover:bg-emerald-50; }
.reaction-empathy { @apply text-blue-600 hover:bg-blue-50; }
.reaction-wonderful { @apply text-purple-600 hover:bg-purple-50; }
```

### アニメーション
- クリック時: Scale + Heartbeat エフェクト
- ホバー時: 滑らかな背景色変化
- カウント変化: Fade In/Out トランジション
- アクティブ状態: 満たされたアイコン

### アクセシビリティ
- Screen Reader対応
- Keyboard操作サポート
- Focus状態の視覚化
- Reduced Motion対応

## 7. パフォーマンス最適化

### React最適化
- React.memo: 不要な再描画防止
- useCallback: イベントハンドラー安定化
- Debouncing: 連続クリック防止（300ms）
- Bundle最適化: Tree Shaking活用

### 監視指標
- リアクション成功率 >99%
- API レスポンス時間 <500ms
- UI反応時間 <100ms
- エラー率 <1%

## 8. テスト戦略

### テスト階層
- Unit Tests: Jest + RTL（コンポーネント単体）
- Integration Tests: API連携・状態管理
- E2E Tests: Playwright（ユーザーシナリオ）

### テスト観点
- 楽観的更新の動作確認
- エラーロールバック機能
- アクセシビリティ属性
- 複数リアクション同期

## 9. 段階的実装ロードマップ

### Phase 1: 基盤理解 (1-2日)
- 型定義学習
- データフロー理解  
- 既存パターン研究

### Phase 2: コア機能実装 (3-5日)
- Hono API実装
- Prisma操作学習
- useReactions フック作成

### Phase 3: UI/UX実装 (2-3日)
- ReactionButton作成
- アニメーション実装
- アクセシビリティ対応

### Phase 4: 統合・テスト (2-3日)
- PostCard統合
- テスト作成
- パフォーマンス最適化

## 10. 学習ポイント

### 技術学習目標
- データベース設計思考（リレーション、制約）
- React状態管理（楽観的更新）
- API設計哲学（RESTful + UX両立）
- コンポーネント設計（再利用性・保守性）

### PostCard統合ポイント
既存PostCard.tsx（line 70付近）の適切な位置にReactionBarを配置:
```jsx
// 投稿内容の後、時刻表示の前
<CardContent className="pt-0">
  <p className="text-gray-800 leading-relaxed whitespace-pre-wrap">
    {post.content}
  </p>
  
  {/* 新規追加: ReactionBar */}
  <ReactionBar 
    postId={post.id}
    reactions={reactions}
    userReactions={userReactions}
  />
</CardContent>
```

## 重要な設計哲学

### Sanctuaryらしさの体現
- 攻撃的でない温かみのあるリアクション
- ポジティブコミュニケーションの促進
- 感情豊かな表現の多様性
- 心の安全地帯にふさわしい機能設計

### 技術的独立性
- ベンダーロックイン回避
- 完全な制御権確保
- 拡張性の高い設計
- 保守しやすいコードベース

この設計により、Sanctuaryの独自性を保ちながら技術的に堅牢で学習効果の高いリアクション機能の実装が可能になります。